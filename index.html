<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BONA BEETLE LITE</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    colors: { 
                        bona: { 
                            black: '#0f0f0f', 
                            dark: '#1a1a1a', 
                            card: '#262626', 
                            gold: '#d4af37', 
                            text: '#e5e5e5', 
                            muted: '#a3a3a3', 
                            danger: '#ef4444', 
                            success: '#10b981' 
                        } 
                    } 
                }
            }
        }
    </script>
    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: #0f0f0f; color: #e5e5e5; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        #app-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 480px; margin: 0 auto; position: relative; background-color: #0f0f0f; }
        
        /* è¦–åœ–åˆ‡æ› */
        .view-section { position: absolute; inset: 0; display: none; flex-direction: column; background-color: #0f0f0f; z-index: 10; }
        .view-section.active { display: flex; }
        
        /* é ‚éƒ¨å›ºå®š Header */
        .fixed-header { position: absolute; top: 0; left: 0; right: 0; z-index: 50; background-color: rgba(15,15,15,0.98); border-bottom: 1px solid #333; padding-top: max(env(safe-area-inset-top), 20px); min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        
        /* å…§å®¹æ»¾å‹•å€ */
        .app-content { flex: 1; overflow-y: auto; padding-top: 140px; padding-bottom: 100px; padding-left: 1.25rem; padding-right: 1.25rem; }
        
        /* åº•éƒ¨å°èˆª */
        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; z-index: 100; background-color: rgba(15,15,15,0.95); border-top: 1px solid #333; height: 85px; display: grid; grid-template-columns: repeat(3, 1fr); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; transition: all 0.3s; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; }
        .nav-item.active-tab { color: #d4af37; }
        
        /* UI å…ƒä»¶ */
        .glass-panel { background: rgba(38,38,38,0.8); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .list-section { margin-bottom: 24px; }
        .list-header { font-size: 11px; font-weight: 800; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 6px; display: flex; justify-content: space-between; align-items: center; letter-spacing: 0.1em; }
        
        .loader { border: 3px solid #333; border-top: 3px solid #d4af37; border-radius: 50%; width: 32px; height: 32px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input, select { background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: border-color 0.3s; }
        input:focus { border-color: #d4af37; }
    </style>
</head>
<body>

    <!-- åŠ è¼‰é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[999] hidden flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-bona-gold text-xs font-bold tracking-[0.2em] animate-pulse">ç³»çµ±åŒæ­¥ä¸­</p>
    </div>

    <div id="app-container">
        
        <!-- VIEW: AUTH (ç™»å…¥ç•«é¢) -->
        <div id="view-auth" class="view-section active flex items-center justify-center px-8">
            <div class="w-full max-w-sm text-center">
                <div class="mb-12">
                    <h1 class="text-3xl font-black text-white tracking-tighter italic">BONA<span class="text-bona-gold">LITE</span></h1>
                    <p class="text-bona-muted text-[10px] tracking-[0.3em] uppercase mt-2">Breeding Management System</p>
                </div>
                <div class="space-y-4">
                    <input type="password" id="auth-key" placeholder="è¼¸å…¥æˆæ¬Šå¯†é‘° (License Key)" class="text-center font-mono">
                    <button onclick="handleLogin()" class="w-full bg-bona-gold text-black font-black py-4 rounded-xl hover:opacity-90 active:scale-95 transition-all">é€²å…¥ç³»çµ±</button>
                    <p class="text-[9px] text-gray-600 mt-8 font-mono">V1.7.0 STABLE | POWERED BY BBS</p>
                </div>
            </div>
        </div>

        <!-- VIEW: MAIN (ä¸»ç¨‹å¼ç•«é¢) -->
        <div id="view-main" class="view-section">
            <header class="fixed-header px-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="font-black text-lg tracking-wide text-white italic">BONA <span class="text-bona-gold text-sm not-italic">LITE</span></span>
                    <div id="user-display" class="bg-bona-card px-3 py-1 rounded-full border border-gray-800 text-[10px] font-mono text-bona-gold">--</div>
                </div>
                <div class="px-1">
                    <div class="flex justify-between text-[9px] text-gray-500 mb-1.5 font-bold uppercase tracking-widest">
                        <span>å€‹é«”è³‡ç”¢é¡åº¦</span>
                        <span id="quota-text">0 / 0</span>
                    </div>
                    <div class="bg-gray-800/50 rounded-full h-1 w-full overflow-hidden">
                        <div id="quota-bar" class="bg-bona-gold h-full transition-all duration-1000" style="width: 0%;"></div>
                    </div>
                </div>
            </header>

            <!-- TAB 1: HOME (éŒ„å…¥èˆ‡æŸ¥è©¢) -->
            <main id="tab-home" class="app-content">
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button class="glass-panel p-6 rounded-2xl flex flex-col items-center justify-center gap-3 active:scale-95 transition-all border-bona-gold/30">
                        <i class="fa-solid fa-qrcode text-bona-gold text-2xl"></i>
                        <span class="text-[11px] font-bold">æƒç¢¼ä½œæ¥­</span>
                    </button>
                    <button class="glass-panel p-6 rounded-2xl flex flex-col items-center justify-center gap-3 active:scale-95 transition-all">
                        <i class="fa-solid fa-plus text-bona-gold text-2xl"></i>
                        <span class="text-[11px] font-bold">æ–°èŸ²éŒ„å…¥</span>
                    </button>
                </div>
                
                <div class="list-section">
                    <h4 class="list-header"><span>æœ€è¿‘æ“ä½œç´€éŒ„</span></h4>
                    <div id="recent-logs" class="text-center py-12 text-gray-600 text-[10px] uppercase tracking-widest">ç›®å‰å°šç„¡æ•¸æ“š</div>
                </div>
            </main>

            <!-- TAB 2: BUTLER (æ™ºæ…§ç®¡å®¶) -->
            <main id="tab-butler" class="app-content hidden">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h3 class="text-white text-xl font-bold">æ›åœŸå·¥ä½œå–®</h3>
                        <p class="text-[10px] text-bona-muted uppercase tracking-widest">æ•¸æ“šç®¡å®¶ | 60 å¤©é€±æœŸé è­¦</p>
                    </div>
                    <button onclick="refreshTaskButler()" class="bg-bona-card p-3 rounded-xl border border-gray-800 text-bona-gold active:rotate-180 transition-all duration-500"><i class="fa-solid fa-rotate"></i></button>
                </div>

                <div id="section-overdue" class="list-section hidden">
                    <h4 class="list-header text-bona-danger"><span>ğŸ”´ å·²é€¾æœŸ (OVERDUE)</span><span id="count-overdue" class="bg-bona-danger/10 px-2 rounded">0</span></h4>
                    <div id="list-overdue" class="space-y-3"></div>
                </div>

                <div id="section-warning" class="list-section hidden">
                    <h4 class="list-header text-bona-gold"><span>ğŸŸ¡ è­¦ç¤º (URGENT - 14D)</span><span id="count-warning" class="bg-bona-gold/10 px-2 rounded">0</span></h4>
                    <div id="list-warning" class="space-y-3"></div>
                </div>

                <div id="section-safe" class="list-section hidden">
                    <h4 class="list-header text-bona-success"><span>ğŸŸ¢ å®‰å…¨ (SAFE - 30D)</span><span id="count-safe" class="bg-bona-success/10 px-2 rounded">0</span></h4>
                    <div id="list-safe" class="space-y-3"></div>
                </div>

                <div id="butler-empty" class="hidden text-center py-24 text-gray-700">
                    <i class="fa-solid fa-circle-check text-3xl mb-4 opacity-20"></i>
                    <p class="text-[10px] uppercase tracking-widest font-bold">æ‰€æœ‰å€‹é«”ç‹€æ…‹è‰¯å¥½</p>
                </div>
            </main>

            <!-- TAB 3: ASSET (è³‡ç”¢åˆ†æ) -->
            <main id="tab-asset" class="app-content hidden">
                <div class="text-center py-40">
                    <i class="fa-solid fa-chart-pie text-gray-800 text-5xl mb-6"></i>
                    <p class="text-bona-gold text-xs font-bold uppercase tracking-widest">Bona Asset Intelligence</p>
                    <p class="text-gray-600 text-[10px] mt-2">é€²éšè³‡ç”¢åˆ†æåŠŸèƒ½é–‹ç™¼ä¸­</p>
                </div>
            </main>

            <!-- å°èˆªæ¬„ -->
            <nav class="bottom-nav">
                <button onclick="switchTab('home')" id="nav-home" class="nav-item active-tab"><i class="fa-solid fa-house-chimney mb-1.5 text-lg"></i><span>é¦–é </span></button>
                <button onclick="switchTab('butler')" id="nav-butler" class="nav-item"><i class="fa-solid fa-calendar-check mb-1.5 text-lg"></i><span>ç®¡å®¶</span></button>
                <button onclick="switchTab('asset')" id="nav-asset" class="nav-item"><i class="fa-solid fa-layer-group mb-1.5 text-lg"></i><span>è³‡ç”¢</span></button>
            </nav>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = "https://hook.us2.make.com/dft05gnm8d1nnhq1uw9owyy5rbon904w";
        let currentUser = localStorage.getItem('user_key');

        // --- è¦–åœ–ç®¡ç† ---
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-tab'));
            document.getElementById(`nav-${tabName}`).classList.add('active-tab');

            if(tabName === 'butler') refreshTaskButler();
        }

        // --- ç™»å…¥é‚è¼¯ ---
        async function handleLogin() {
            const key = document.getElementById('auth-key').value;
            if(!key) return alert('è«‹è¼¸å…¥æˆæ¬Šç¢¼');

            showLoading(true);
            try {
                const res = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'auth', userId: key })
                });
                const data = await res.json();

                if(data.status === 'success' || data.plan) {
                    localStorage.setItem('user_key', key);
                    currentUser = key;
                    updateUserUI(data);
                    switchView('view-main');
                } else {
                    alert('æˆæ¬Šç¢¼ç„¡æ•ˆæˆ–å·²éæœŸ');
                }
            } catch(e) {
                alert('ä¼ºæœå™¨é€£ç·šå¤±æ•—');
            } finally {
                showLoading(false);
            }
        }

        function updateUserUI(data) {
            document.getElementById('user-display').innerText = currentUser;
            if(data.used !== undefined) {
                const max = data.max || 100;
                const perc = Math.min((data.used / max) * 100, 100);
                document.getElementById('quota-text').innerText = `${data.used} / ${max}`;
                document.getElementById('quota-bar').style.width = `${perc}%`;
            }
        }

        // --- ç®¡å®¶é‚è¼¯ (æ ¸å¿ƒå»é‡èˆ‡åˆ†é¡) ---
        async function refreshTaskButler() {
            const lists = { overdue: document.getElementById('list-overdue'), warning: document.getElementById('list-warning'), safe: document.getElementById('list-safe') };
            const sections = { overdue: document.getElementById('section-overdue'), warning: document.getElementById('section-warning'), safe: document.getElementById('section-safe'), empty: document.getElementById('butler-empty') };
            
            Object.values(lists).forEach(l => l.innerHTML = '');
            Object.values(sections).forEach(s => s.classList.add('hidden'));
            showLoading(true);

            try {
                const res = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'census', userId: currentUser })
                });
                const data = await res.json();
                const rawItems = data.items || data.data || [];

                if (rawItems.length === 0) {
                    sections.empty.classList.remove('hidden');
                    return;
                }

                // 1. å»é‡ï¼šåªä¿ç•™æ¯å€‹ ID æœ€æ–°çš„ç´€éŒ„
                const uniqueMap = {};
                rawItems.forEach(item => {
                    const id = item.id || item.ID;
                    if (!id || !item.date_check) return;
                    const date = new Date(item.date_check);
                    if (isNaN(date.getTime())) return;

                    if (!uniqueMap[id] || date > new Date(uniqueMap[id].rawDate)) {
                        uniqueMap[id] = {
                            id: id,
                            lastDate: item.date_check.split('T')[0],
                            weight: item.weight || 0,
                            rawDate: date
                        };
                    }
                });

                // 2. åˆ†é¡èˆ‡æ’åº (ä¾é è¨ˆæ›åœŸæ—¥ç”±è¿‘åˆ°é )
                const today = new Date();
                let counts = { overdue: 0, warning: 0, safe: 0 };
                
                const sortedBugs = Object.values(uniqueMap).sort((a, b) => {
                    const nextA = new Date(a.rawDate).setDate(a.rawDate.getDate() + 60);
                    const nextB = new Date(b.rawDate).setDate(b.rawDate.getDate() + 60);
                    return nextA - nextB;
                });

                sortedBugs.forEach(bug => {
                    const nextDate = new Date(bug.rawDate);
                    nextDate.setDate(nextDate.getDate() + 60);
                    const diffDays = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                    const nextDateStr = nextDate.toISOString().split('T')[0];
                    
                    const card = `
                        <div class="glass-panel p-4 rounded-xl active:bg-white/5 transition-all">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-white font-mono font-bold tracking-tighter">${bug.id}</span>
                                <span class="text-[9px] font-black px-2 py-0.5 rounded ${diffDays < 0 ? 'bg-bona-danger/20 text-bona-danger' : (diffDays <= 14 ? 'bg-bona-gold/20 text-bona-gold' : 'bg-bona-success/20 text-bona-success')}">
                                    ${diffDays < 0 ? 'å·²é€¾æœŸ ' + Math.abs(diffDays) + ' å¤©' : 'å‰©é¤˜ ' + diffDays + ' å¤©'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-y-2 text-[10px] font-mono">
                                <div class="text-gray-500">æœ€æ–°æ›åœŸ: <span class="text-white">${bug.lastDate}</span></div>
                                <div class="text-gray-500 text-right">é è¨ˆæ›åœŸ: <span class="text-bona-gold font-bold">${nextDateStr}</span></div>
                                <div class="col-span-2 text-gray-500">ç•¶å‰é«”é‡: <span class="text-white font-bold">${bug.weight}g</span></div>
                            </div>
                        </div>
                    `;

                    if (diffDays < 0) { lists.overdue.innerHTML += card; counts.overdue++; sections.overdue.classList.remove('hidden'); }
                    else if (diffDays <= 14) { lists.warning.innerHTML += card; counts.warning++; sections.warning.classList.remove('hidden'); }
                    else if (diffDays <= 30) { lists.safe.innerHTML += card; counts.safe++; sections.safe.classList.remove('hidden'); }
                });

                document.getElementById('count-overdue').innerText = counts.overdue;
                document.getElementById('count-warning').innerText = counts.warning;
                document.getElementById('count-safe').innerText = counts.safe;

                if (counts.overdue + counts.warning + counts.safe === 0) sections.empty.classList.remove('hidden');

            } catch (e) {
                console.error("Refresh Error:", e);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').classList[show ? 'remove' : 'add']('hidden');
        }

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            if(currentUser) {
                switchView('view-main');
                switchTab('home');
                handleLogin(); // è‡ªå‹•é‡æ–°é©—è­‰èˆ‡åŒæ­¥
            }
        };
    </script>
</body>
</html>