<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BONA BEETLE LITE</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { bona: { black: '#0f0f0f', dark: '#1a1a1a', card: '#262626', gold: '#d4af37', text: '#e5e5e5', muted: '#a3a3a3', danger: '#ef4444', success: '#10b981' } } }
            }
        }
    </script>
    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: #0f0f0f; color: #e5e5e5; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        #app-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 480px; margin: 0 auto; position: relative; background-color: #0f0f0f; }
        .view-section { position: absolute; inset: 0; display: none; flex-direction: column; background-color: #0f0f0f; z-index: 10; }
        .view-section.active { display: flex; }
        .fixed-header { position: absolute; top: 0; left: 0; right: 0; z-index: 50; background-color: rgba(15,15,15,0.98); border-bottom: 1px solid #333; padding-top: max(env(safe-area-inset-top), 20px); min-height: 140px; display: flex; flex-direction: column; justify-content: center; }
        .app-content { flex: 1; overflow-y: auto; padding-top: 160px; padding-bottom: 100px; padding-left: 1rem; padding-right: 1rem; }
        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; z-index: 100; background-color: rgba(15,15,15,0.95); border-top: 1px solid #333; height: 80px; display: grid; grid-template-columns: repeat(3, 1fr); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; transition: all 0.3s; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .nav-item.active-tab { color: #d4af37; }
        .glass-panel { background: rgba(38,38,38,0.9); border: 1px solid rgba(255,255,255,0.1); }
        .gold-gradient { background: linear-gradient(135deg, #d4af37 0%, #a68a2e 100%); }
        .list-section { margin-bottom: 24px; }
        .list-header { font-size: 12px; font-weight: bold; margin-bottom: 12px; border-bottom: 1px solid #333; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
        .loader { border: 4px solid #333; border-top: 4px solid #d4af37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- åŠ è¼‰é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[999] hidden flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-bona-gold text-lg font-bold tracking-wider animate-pulse">æ•¸æ“šåŒæ­¥ä¸­</p>
    </div>

    <div id="app-container">
        <!-- ä¸»è¦–åœ– -->
        <div id="view-main" class="view-section active">
            <header class="fixed-header px-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-lg tracking-wide text-white">BONA <span class="text-bona-gold">LITE</span></span>
                    <button class="text-gray-500"><i class="fa-solid fa-bell"></i></button>
                </div>
                <div class="px-2">
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1 font-mono">
                        <span>è³‡ç”¢é¡åº¦: 85%</span>
                        <span class="text-bona-gold uppercase tracking-tighter">Lite Plan</span>
                    </div>
                    <div class="bg-gray-800 rounded-full h-1 w-full"><div class="bg-bona-gold h-full rounded-full" style="width: 85%;"></div></div>
                </div>
            </header>

            <!-- TAB 2: ç®¡å®¶åˆ†é  (æ›åœŸé è­¦ç³»çµ±) -->
            <main id="tab-content-butler" class="app-content">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h3 class="text-white text-xl font-bold">æ›åœŸå·¥ä½œå–®</h3>
                        <p class="text-[10px] text-bona-muted uppercase tracking-widest">æ™ºèƒ½åˆ†æ | 60 å¤©é€±æœŸ</p>
                    </div>
                    <button onclick="refreshTaskButler()" class="bg-bona-card p-2 rounded-lg border border-gray-700 text-bona-gold active:scale-90 transition-transform"><i class="fa-solid fa-rotate"></i></button>
                </div>

                <!-- é€¾æœŸå€ (Overdue) -->
                <div id="section-overdue" class="list-section">
                    <h4 class="list-header text-bona-danger">
                        <span>ğŸ”´ å·²é€¾æœŸ (OVERDUE)</span>
                        <span id="count-overdue" class="bg-bona-danger/20 px-2 rounded text-[10px]">0</span>
                    </h4>
                    <div id="list-overdue" class="space-y-3"></div>
                </div>

                <!-- è­¦ç¤ºå€ (Warning/Urgent) -->
                <div id="section-warning" class="list-section">
                    <h4 class="list-header text-bona-gold">
                        <span>ğŸŸ¡ è­¦ç¤º (URGENT - 14D)</span>
                        <span id="count-warning" class="bg-bona-gold/20 px-2 rounded text-[10px]">0</span>
                    </h4>
                    <div id="list-warning" class="space-y-3"></div>
                </div>

                <!-- å®‰å…¨å€ (Safe/Future) -->
                <div id="section-safe" class="list-section">
                    <h4 class="list-header text-bona-success">
                        <span>ğŸŸ¢ å®‰å…¨ (SAFE - 30D)</span>
                        <span id="count-safe" class="bg-bona-success/20 px-2 rounded text-[10px]">0</span>
                    </h4>
                    <div id="list-safe" class="space-y-3"></div>
                </div>
                
                <!-- ç©ºç™½æç¤º -->
                <div id="butler-empty" class="hidden text-center py-20 text-gray-600">
                    <i class="fa-solid fa-circle-check text-4xl mb-4 block"></i>
                    <p class="text-xs uppercase tracking-widest">ç›®å‰ç„¡å¾…è™•ç†ä»»å‹™</p>
                </div>
            </main>

            <nav class="bottom-nav">
                <button class="nav-item"><i class="fa-solid fa-qrcode mb-1 text-xl"></i><span>éŒ„å…¥</span></button>
                <button class="nav-item active-tab"><i class="fa-solid fa-calendar-check mb-1 text-xl"></i><span>ç®¡å®¶</span></button>
                <button class="nav-item"><i class="fa-solid fa-chart-line mb-1 text-xl"></i><span>è³‡ç”¢</span></button>
            </nav>
        </div>
    </div>

    <script>
        // è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸
        const WEBHOOK_URL = "https://hook.us2.make.com/dft05gnm8d1nnhq1uw9owyy5rbon904w";
        const currentUser = localStorage.getItem('user_key') || "Bona-Demo-Key";

        /**
         * åˆ·æ–°ç®¡å®¶ä»»å‹™æ¸…å–®
         * é‚è¼¯ï¼šå¾æµæ°´å¸³ä¸­æå–æ¯å€‹ ID çš„æœ€æ–°ç´€éŒ„ï¼Œä¸¦è¨ˆç®—ä¸‹æ¬¡æ›åœŸæ™‚é–“ã€‚
         */
        async function refreshTaskButler() {
            const lists = {
                overdue: document.getElementById('list-overdue'),
                warning: document.getElementById('list-warning'),
                safe: document.getElementById('list-safe')
            };
            const sections = {
                overdue: document.getElementById('section-overdue'),
                warning: document.getElementById('section-warning'),
                safe: document.getElementById('section-safe'),
                empty: document.getElementById('butler-empty')
            };
            
            // UI é‡ç½®
            Object.values(lists).forEach(l => l.innerHTML = '');
            Object.values(sections).forEach(s => s.classList.add('hidden'));
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                const res = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'census', userId: currentUser })
                });
                
                if (!res.ok) throw new Error('Network response was not ok');
                
                const data = await res.json();
                const rawItems = data.items || data.data || [];

                if (rawItems.length === 0) {
                    sections.empty.classList.remove('hidden');
                    return;
                }

                const uniqueMap = {};
                rawItems.forEach(item => {
                    const id = item.id || item.ID;
                    // å®‰å…¨æª¢æŸ¥ï¼šè‹¥ç„¡ ID æˆ– ç„¡æ—¥æœŸå‰‡è·³é
                    if (!id || !item.date_check) return;

                    const date = new Date(item.date_check);
                    if (isNaN(date.getTime())) return;

                    // åƒ…ä¿ç•™è©² ID æœ€æ–°çš„ç´€éŒ„
                    if (!uniqueMap[id] || date > new Date(uniqueMap[id].rawDate)) {
                        uniqueMap[id] = {
                            id: id,
                            lastDate: item.date_check.split('T')[0], // é€™è£¡å·²åŒ…å«ç©ºå€¼æª¢æŸ¥
                            weight: item.weight || 0,
                            rawDate: date
                        };
                    }
                });

                const today = new Date();
                let counts = { overdue: 0, warning: 0, safe: 0 };

                // æ’åºä¸¦æ¸²æŸ“
                const sortedBugs = Object.values(uniqueMap).sort((a, b) => {
                    const nextA = new Date(a.rawDate).setDate(new Date(a.rawDate).getDate() + 60);
                    const nextB = new Date(b.rawDate).setDate(new Date(b.rawDate).getDate() + 60);
                    return nextA - nextB;
                });

                sortedBugs.forEach(bug => {
                    const nextDate = new Date(bug.rawDate);
                    nextDate.setDate(nextDate.getDate() + 60);
                    const diffDays = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                    
                    const nextDateStr = nextDate.toISOString().split('T')[0];
                    
                    const cardHtml = `
                        <div class="glass-panel p-4 rounded-xl relative overflow-hidden active:bg-white/5 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-white font-mono font-bold tracking-wider">${bug.id}</span>
                                <span class="text-[10px] font-black px-2 py-0.5 rounded ${diffDays < 0 ? 'bg-bona-danger/20 text-bona-danger' : (diffDays <= 14 ? 'bg-bona-gold/20 text-bona-gold' : 'bg-bona-success/20 text-bona-success')} uppercase">
                                    ${diffDays < 0 ? 'Overdue ' + Math.abs(diffDays) + 'd' : 'Due in ' + diffDays + 'd'}
                                </span>
                            </div>
                            <div class="grid grid-cols-2 gap-y-2 text-[11px]">
                                <div class="text-gray-500">æœ€æ–°æ›åœŸ: <span class="text-white font-mono">${bug.lastDate}</span></div>
                                <div class="text-gray-500 text-right">é è¨ˆä¸‹æ¬¡: <span class="text-bona-gold font-mono">${nextDateStr}</span></div>
                                <div class="col-span-2 flex items-center gap-2">
                                    <span class="text-gray-500">ç•¶å‰é«”é‡:</span>
                                    <span class="text-white font-bold">${bug.weight}g</span>
                                    <div class="flex-1 h-[1px] bg-gray-800"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    // æ ¹æ“šæ—¥æœŸå·®åˆ†å…¥ä¸åŒå€å¡Š
                    if (diffDays < 0) {
                        lists.overdue.innerHTML += cardHtml;
                        counts.overdue++;
                        sections.overdue.classList.remove('hidden');
                    } else if (diffDays <= 14) {
                        lists.warning.innerHTML += cardHtml;
                        counts.warning++;
                        sections.warning.classList.remove('hidden');
                    } else if (diffDays <= 30) {
                        lists.safe.innerHTML += cardHtml;
                        counts.safe++;
                        sections.safe.classList.remove('hidden');
                    }
                });

                document.getElementById('count-overdue').innerText = counts.overdue;
                document.getElementById('count-warning').innerText = counts.warning;
                document.getElementById('count-safe').innerText = counts.safe;
                
                if (counts.overdue + counts.warning + counts.safe === 0) {
                    sections.empty.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Refresh Task Error:", error);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // åˆå§‹åŒ–
        window.onload = refreshTaskButler;
    </script>
</body>
</html>