<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BONA BEETLE PRO</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { bona: { black: '#0f0f0f', dark: '#1a1a1a', card: '#262626', gold: '#d4af37', text: '#e5e5e5', muted: '#a3a3a3', danger: '#ef4444', success: '#10b981' } } }
            }
        }
    </script>
    <style>
        html { height: 100%; overflow: hidden; background-color: #0f0f0f; }
        body { 
            height: 100%; width: 100%; margin: 0; padding: 0; 
            background-color: #0f0f0f; color: #e5e5e5; 
            overflow: hidden; overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        #app-container {
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 480px;
            margin: 0 auto; position: relative; background-color: #0f0f0f;
        }
        .fixed-header-wrapper {
            position: absolute; top: 0; left: 0; right: 0; z-index: 50;
            background-color: rgba(15, 15, 15, 0.98);
            border-bottom: 1px solid #333;
            padding-top: max(env(safe-area-inset-top), 20px);
            min-height: 140px; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .dashboard-content {
            flex: 1; overflow-y: auto; padding-top: 160px; padding-bottom: 110px; padding-left: 1rem; padding-right: 1rem;
        }
        .dashboard-nav {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 100;
            background-color: rgba(15, 15, 15, 0.95);
            border-top: 1px solid #333;
            height: 90px; display: grid; grid-template-columns: repeat(4, 1fr);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #444; transition: all 0.3s; font-size: 10px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        .nav-item.active-tab { color: #d4af37; }
        .gold-gradient { background: linear-gradient(135deg, #d4af37 0%, #a68a2e 100%); }
        .glass-panel { background: rgba(38, 38, 38, 0.9); border: 1px solid rgba(255, 255, 255, 0.05); }
        .loader { border: 3px solid #333; border-top: 3px solid #d4af37; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input, select { -webkit-appearance: none; background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 12px; width: 100%; outline: none; transition: border 0.3s; }
        input:focus { border-color: #d4af37; }
        .batch-row { background: #111; border: 1px solid #333; margin-bottom: 12px; border-radius: 16px; padding: 18px; position: relative; border-left: 4px solid #d4af37; }
    </style>
</head>
<body class="font-sans antialiased">

    <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[300] hidden flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-bona-gold text-[10px] font-black tracking-[0.4em] animate-pulse uppercase">Syncing Cloud Assets</p>
    </div>

    <div id="app-container">
        <!-- VIEW: LOGIN -->
        <div id="view-login" class="flex h-full flex-col items-center justify-center p-8 z-10 relative">
            <div class="mb-14 text-center">
                <div class="w-24 h-24 mx-auto mb-8 bg-bona-dark rounded-full border border-bona-gold/40 flex items-center justify-center shadow-2xl shadow-bona-gold/10">
                     <i class="fa-solid fa-bug text-4xl text-bona-gold"></i>
                </div>
                <h1 class="text-4xl font-black text-white tracking-[0.2em] italic">BONA<span class="text-bona-gold not-italic">PRO</span></h1>
                <p class="text-[9px] text-bona-muted mt-3 tracking-[0.5em] uppercase">Beetle Assets Portfolio</p>
            </div>
            <div class="w-full space-y-5 max-w-xs">
                <input type="text" id="login-license" class="w-full bg-bona-black border border-gray-800 text-bona-gold rounded-2xl p-5 text-center font-mono tracking-widest text-lg" placeholder="ENTER LICENSE">
                <button onclick="window.handleLogin()" class="w-full gold-gradient text-black font-black py-5 rounded-2xl shadow-xl active:scale-95 transition-all text-xs uppercase tracking-widest">授權進入系統</button>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="hidden h-full flex-col relative">
            <header class="fixed-header-wrapper px-6">
                <div class="flex justify-between items-center mb-5 w-full">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-2xl border border-bona-gold/20 flex items-center justify-center bg-black p-1">
                            <i class="fa-solid fa-bug text-bona-gold text-xl"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="font-black text-lg tracking-widest text-white uppercase">Bona Systems</span>
                            <span class="text-[9px] text-gray-500 font-mono opacity-80" id="lic-display">LIC: --</span>
                        </div>
                    </div>
                    <button onclick="window.logout()" class="text-gray-700 hover:text-red-500 p-2 transition-colors"><i class="fa-solid fa-power-off text-lg"></i></button>
                </div>
                <div class="w-full px-1">
                    <div class="flex justify-between text-[9px] text-gray-500 mb-2 uppercase font-black tracking-widest">
                        <span>Database Efficiency</span>
                        <div class="flex items-center space-x-2">
                            <span id="quota-text" class="text-gray-300">-- / --</span>
                            <div id="online-indicator" class="w-1.5 h-1.5 rounded-full bg-red-600"></div>
                        </div>
                    </div>
                    <div class="bg-[#1a1a1a] rounded-full h-1 w-full overflow-hidden">
                        <div id="quota-bar-fill" class="bg-bona-gold h-full transition-all duration-1000 shadow-[0_0_10px_#d4af37]" style="width: 0%;"></div>
                    </div>
                </div>
            </header>

            <!-- TAB 1: 儀表板 -->
            <main id="tab-home" class="dashboard-content">
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button class="p-8 glass-panel rounded-[2.5rem] flex flex-col items-center justify-center space-y-3 border-bona-gold/10 border active:scale-95 transition-all group">
                        <i class="fa-solid fa-qrcode text-3xl text-[#444] group-active:text-bona-gold transition-colors"></i>
                        <span class="text-[10px] font-black tracking-widest uppercase opacity-40">Scan Asset</span>
                    </button>
                    <button onclick="window.switchTab('batch')" class="p-8 glass-panel rounded-[2.5rem] flex flex-col items-center justify-center space-y-3 active:scale-95 transition-all">
                        <i class="fa-solid fa-layer-group text-3xl text-bona-gold"></i>
                        <span class="text-[10px] font-black tracking-widest uppercase">Batch Entry</span>
                    </button>
                </div>

                <div class="bg-gradient-to-br from-[#111] to-black p-6 rounded-[2rem] border border-white/5 shadow-2xl">
                    <h3 class="text-bona-gold text-[10px] font-black uppercase tracking-[0.4em] mb-5 flex items-center">
                        <div class="w-1.5 h-1.5 bg-bona-gold rounded-full mr-3 animate-pulse"></div>
                        Butler Sync Tasks
                    </h3>
                    <div id="butler-list" class="space-y-3">
                        <div class="text-center py-12 opacity-20">
                            <p class="text-[9px] font-black uppercase tracking-[0.3em]">No Active Commands</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- TAB 2: 批量 (智慧選擇優化) -->
            <main id="tab-batch" class="dashboard-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-white text-xl font-black tracking-widest uppercase italic">Batch Entry</h3>
                        <p class="text-[9px] text-gray-600 uppercase tracking-widest mt-1">Automated Identification System</p>
                    </div>
                    <button onclick="window.addBatchRow()" class="w-12 h-12 bg-bona-gold/10 border border-bona-gold/30 text-bona-gold rounded-2xl active:scale-90 transition-all flex items-center justify-center">
                        <i class="fa-solid fa-plus text-lg"></i>
                    </button>
                </div>
                <div id="batch-container" class="space-y-4">
                    <!-- Batch rows inject here -->
                </div>
                <button onclick="window.submitBatch()" id="btn-batch-submit" class="w-full gold-gradient text-black font-black py-5 rounded-2xl mt-8 uppercase tracking-[0.3em] text-xs shadow-2xl active:scale-95 transition-all opacity-20" disabled>
                    Push to Notion Cloud
                </button>
            </main>

            <!-- TAB 3: 管家 -->
            <main id="tab-butler" class="dashboard-content hidden">
                <div class="text-center py-40 opacity-20">
                    <i class="fa-solid fa-calendar-days text-5xl mb-4"></i>
                    <p class="text-[10px] font-black uppercase tracking-[0.3em]">Advanced Butler Console</p>
                </div>
            </main>

            <!-- TAB 4: 我的 -->
            <main id="tab-asset" class="dashboard-content hidden">
                <div class="text-center py-40 opacity-20 italic">
                    <p class="text-[10px] font-black uppercase tracking-[0.5em]">Beetle Assets Portfolio</p>
                    <p class="text-[9px] mt-2">PRO v2.5.0 STABLE // ENCRYPTED</p>
                </div>
            </header>

            <!-- BOTTOM NAV -->
            <nav class="dashboard-nav">
                <div onclick="window.switchTab('home')" id="nav-home" class="nav-item active-tab">
                    <i class="fa-solid fa-house-chimney mb-2 text-xl"></i><span>儀表板</span>
                </div>
                <div onclick="window.switchTab('batch')" id="nav-batch" class="nav-item">
                    <i class="fa-solid fa-layer-group mb-2 text-xl"></i><span>批量</span>
                </div>
                <div onclick="window.switchTab('butler')" id="nav-butler" class="nav-item">
                    <i class="fa-solid fa-calendar-check mb-2 text-xl"></i><span>管家</span>
                </div>
                <div onclick="window.switchTab('asset')" id="nav-asset" class="nav-item">
                    <i class="fa-solid fa-user-gear mb-2 text-xl"></i><span>我的</span>
                </div>
            </nav>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = "https://hook.us2.make.com/3t09tt0d685yi05vfbfjqha01l4mg4pu";
        const API_KEY = "BonaPro-Safe-19790514";

        let session = {
            license: localStorage.getItem('bona_pro_lic') || null,
            userId: localStorage.getItem('bona_pro_uid') || null,
            stats: { used: 0, max: 50 },
            speciesList: [] // 這裡會儲存從 Notion 同步來的物種清單
        };

        async function callCloud(action, payload = {}) {
            window.showLoading(true);
            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action,
                        license: session.license,
                        userId: session.userId,
                        apiKey: API_KEY,
                        ...payload
                    })
                });
                const text = await response.text();
                window.showLoading(false);
                try {
                    return JSON.parse(text);
                } catch(e) {
                    if (text.toLowerCase().includes('accepted') || response.ok) return { success: true };
                    return { success: false };
                }
            } catch(e) {
                window.showLoading(false);
                return { success: false };
            }
        }

        window.handleLogin = async function() {
            const key = document.getElementById('login-license').value.trim();
            if(!key) return;
            session.license = key;
            const res = await callCloud("VERIFY_USER");
            if(res && (res.success || res.userId)) {
                session.userId = res.userId || "USER_" + key.slice(-4);
                localStorage.setItem('bona_pro_lic', key);
                localStorage.setItem('bona_pro_uid', session.userId);
                window.showDashboard();
                await syncData();
            }
        };

        async function syncData() {
            const res = await callCloud("SYNC_DATA");
            if(res && res.success) {
                document.getElementById('online-indicator').className = "w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]";
                if(res.stats) {
                    session.stats = res.stats;
                    document.getElementById('quota-text').innerText = `${res.stats.used} / ${res.stats.max}`;
                    document.getElementById('quota-bar-fill').style.width = `${Math.min((res.stats.used/res.stats.max)*100, 100)}%`;
                }
                
                // --- 智慧優化：同步物種表 ---
                if(res.species) {
                    session.speciesList = res.species;
                    // 更新批量入庫按鈕狀態
                    document.getElementById('btn-batch-submit').disabled = false;
                    document.getElementById('btn-batch-submit').classList.remove('opacity-20');
                }
                
                if(res.alerts) renderButler(res.alerts);
            }
        }

        function renderButler(alerts) {
            const container = document.getElementById('butler-list');
            if(!alerts || alerts.length === 0) return;
            container.innerHTML = alerts.map(a => `
                <div class="w-full bg-black/40 rounded-2xl p-4 flex justify-between items-center border border-white/5 active:border-bona-gold transition-all">
                    <div class="flex flex-col gap-1">
                        <span class="text-[11px] text-gray-300 font-bold">${a.text}</span>
                        <span class="text-[8px] text-gray-600 font-mono uppercase">${a.specimenId}</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-bona-gold text-[10px]"></i>
                </div>
            `).join('');
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.dashboard-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.add('active-tab');
            if(tab === 'batch' && document.getElementById('batch-container').children.length === 0) window.addBatchRow();
        };

        // --- 批量錄入優化：改為選擇器 ---
        window.addBatchRow = function() {
            const container = document.getElementById('batch-container');
            const div = document.createElement('div');
            div.className = "batch-row animate-in fade-in slide-in-from-right-4";
            
            // 建立物種選擇下拉選單
            const speciesOptions = session.speciesList.length > 0 
                ? session.speciesList.map(s => `<option value="${s.prefix}">${s.name} (${s.prefix})</option>`).join('')
                : `<option value="">請先同步數據...</option>`;

            div.innerHTML = `
                <div class="flex justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-bona-gold rounded-full"></div>
                        <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Digital Asset Entry</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-red-900/50 active:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1.5">
                            <label class="text-[9px] text-gray-600 font-black uppercase ml-1">Species Prefix</label>
                            <select class="batch-prefix" style="font-size: 11px; padding: 12px; font-weight: bold; color: #d4af37;">
                                <option value="">選擇物種代號</option>
                                ${speciesOptions}
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[9px] text-gray-600 font-black uppercase ml-1">Batch ID</label>
                            <input type="text" class="batch-no" placeholder="批次編號" value="01" style="font-size: 11px; padding: 12px; font-family: monospace;">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1.5">
                            <label class="text-[9px] text-gray-600 font-black uppercase ml-1">Mode</label>
                            <select class="batch-mode" style="font-size: 11px; padding: 12px;">
                                <option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option>
                            </select>
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[9px] text-gray-600 font-black uppercase ml-1">Quantity</label>
                            <input type="number" class="batch-qty" value="1" min="1" style="font-size: 11px; padding: 12px;">
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
        };

        window.submitBatch = async function() {
            const rows = document.querySelectorAll('.batch-row');
            const items = Array.from(rows).map(row => ({
                prefix: row.querySelector('.batch-prefix').value,
                batchNo: row.querySelector('.batch-no').value,
                mode: row.querySelector('.batch-mode').value,
                qty: row.querySelector('.batch-qty').value
            }));
            
            if(items.some(i => !i.prefix)) return alert("請選擇物種代號");
            
            const res = await callCloud("BATCH_ONBOARD", { items });
            if(res.success) {
                alert("批量入庫指令已發送至雲端");
                document.getElementById('batch-container').innerHTML = '';
                window.switchTab('home');
                await syncData();
            }
        };

        window.showLoading = (s) => document.getElementById('loading-overlay').classList[s?'remove':'add']('hidden');
        window.showDashboard = () => {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('lic-display').innerText = `LIC: ${session.license.substring(0,8)}****`;
        };
        window.logout = () => { localStorage.clear(); location.reload(); };

        document.addEventListener('DOMContentLoaded', () => {
            if(session.license) {
                window.showDashboard();
                syncData();
            }
        });
    </script>
</body>
</html>