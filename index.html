<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BONA BEETLE LITE</title>
    
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="theme-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { bona: { black: '#0f0f0f', dark: '#1a1a1a', card: '#262626', gold: '#d4af37', text: '#e5e5e5', muted: '#a3a3a3', danger: '#ef4444', success: '#10b981' } } }
            }
        }
    </script>
    <style>
        /* CORE STYLES */
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; background-color: #0f0f0f; color: #e5e5e5; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        #app-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 480px; margin: 0 auto; position: relative; background-color: #0f0f0f; }
        
        /* VIEWS */
        .view-section { position: absolute; inset: 0; display: none; flex-direction: column; background-color: #0f0f0f; z-index: 10; }
        .view-section.active { display: flex; }
        
        /* HEADER & FOOTER */
        .fixed-header { position: absolute; top: 0; left: 0; right: 0; z-index: 50; background-color: rgba(15,15,15,0.98); border-bottom: 1px solid #333; padding-top: max(env(safe-area-inset-top), 20px); min-height: 140px; display: flex; flex-direction: column; justify-content: center; }
        .app-content { flex: 1; overflow-y: auto; padding-top: 160px; padding-bottom: 100px; padding-left: 1rem; padding-right: 1rem; }
        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; z-index: 100; background-color: rgba(15,15,15,0.95); border-top: 1px solid #333; height: 80px; display: grid; grid-template-columns: repeat(3, 1fr); padding-bottom: env(safe-area-inset-bottom); }
        
        /* UI ELEMENTS */
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; transition: all 0.3s; }
        .nav-item.active-tab { color: #d4af37; }
        .glass-panel { background: rgba(38,38,38,0.9); border: 1px solid rgba(255,255,255,0.1); }
        .gold-gradient { background: linear-gradient(135deg, #d4af37 0%, #a68a2e 100%); }
        .loader { border: 4px solid #333; border-top: 4px solid #d4af37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* UTILS */
        .hidden { display: none !important; }
        .list-section { margin-bottom: 20px; }
        .list-header { font-size: 12px; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
    </style>
</head>
<body class="font-sans antialiased text-base">

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[999] hidden flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-bona-gold text-lg font-bold tracking-wider animate-pulse">PROCESSING</p>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification-area" class="fixed top-32 left-1/2 transform -translate-x-1/2 z-[999] w-11/12 max-w-sm space-y-2 pointer-events-none"></div>

    <div id="app-container">

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="view-section active p-6 items-center justify-center">
            <div class="mb-10 text-center">
                <div class="w-24 h-24 mx-auto mb-6 bg-bona-dark rounded-full border-2 border-bona-gold flex items-center justify-center overflow-hidden">
                     <img src="logo.png" onerror="this.style.display='none'" class="w-full h-full object-cover">
                </div>
                <h1 class="text-3xl font-bold text-white tracking-widest uppercase">Bona <span class="text-bona-gold">Lite</span></h1>
            </div>
            <div class="w-full glass-panel p-8 rounded-2xl shadow-2xl space-y-6">
                <input type="text" id="login-license" class="w-full bg-bona-black border border-gray-700 text-white rounded-xl p-4 text-center font-mono text-lg outline-none" placeholder="è¼¸å…¥æˆæ¬Šç¢¼">
                <button onclick="handleLogin()" class="w-full gold-gradient text-black font-black py-4 rounded-xl shadow-lg active:scale-95 transition-transform">ç™»å…¥ç³»çµ±</button>
                <div class="text-center">
                    <a href="https://bonabeetle.com/lite" target="_blank" class="text-gray-500 text-xs hover:text-bona-gold underline">æ²’æœ‰æˆæ¬Šç¢¼ï¼Ÿå‰å¾€å®˜ç¶²</a>
                </div>
            </div>
        </div>

        <!-- VIEW: MAIN APP (Tabs) -->
        <div id="view-main" class="view-section">
            <header class="fixed-header px-4">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-lg tracking-wide text-white">BONA <span class="text-bona-gold">SYSTEMS</span></span>
                    <button onclick="logout()" class="text-gray-500"><i class="fa-solid fa-power-off"></i></button>
                </div>
                <div class="px-2">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>Quota: <span id="quota-text">--/--</span></span>
                        <a href="https://bonabeetle.com/lite" target="_blank" class="text-bona-gold">å¢åŠ é¡åº¦</a>
                    </div>
                    <div class="bg-gray-800 rounded-full h-2 w-full"><div id="quota-bar-fill" class="bg-bona-gold h-full rounded-full" style="width: 0%;"></div></div>
                </div>
            </header>

            <!-- TAB 1: HOME -->
            <main id="tab-content-home" class="app-content">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="openScanner()" class="p-6 glass-panel rounded-2xl flex flex-col items-center justify-center space-y-3">
                        <i class="fa-solid fa-qrcode text-3xl text-bona-gold"></i>
                        <span class="text-xs font-bold uppercase">æƒæéŒ„å…¥</span>
                    </button>
                    <button onclick="showNewEntryForm()" class="p-6 glass-panel rounded-2xl flex flex-col items-center justify-center space-y-3">
                        <i class="fa-solid fa-plus text-3xl text-gray-500"></i>
                        <span class="text-xs font-bold uppercase text-gray-400">æ–°èŸ²å»ºç«‹</span>
                    </button>
                </div>
                <div class="glass-panel p-6 rounded-2xl space-y-4">
                    <h3 class="text-bona-gold text-xs font-bold uppercase border-b border-gray-700 pb-2">å¿«é€Ÿæª¢ç´¢</h3>
                    <div class="relative">
                        <input type="text" id="search-id" class="w-full bg-black border border-gray-700 text-white rounded-lg p-3 pr-10 outline-none" placeholder="è¼¸å…¥ç·¨è™Ÿ">
                        <button onclick="handleManualSearch()" class="absolute right-2 top-2 bottom-2 text-bona-gold px-2"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>
            </main>

            <!-- TAB 2: BUTLER (Smart Reminder) -->
            <main id="tab-content-butler" class="app-content hidden">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h3 class="text-bona-gold text-lg font-bold">æ›åœŸå·¥ä½œå–®</h3>
                        <p class="text-[10px] text-gray-500">é€±æœŸ: 60å¤© | è‡ªå‹•éæ¿¾æœ€æ–°æ•¸æ“š</p>
                    </div>
                    <button onclick="refreshTaskButler()" class="text-xs text-white bg-white/10 px-3 py-1.5 rounded-lg border border-white/20"><i class="fa-solid fa-rotate mr-1"></i>é‡æ•´</button>
                </div>
                
                <!-- é€¾æœŸå€ -->
                <div id="section-overdue" class="list-section hidden">
                    <h4 class="list-header text-red-500">
                        <span>âš ï¸ å·²é€¾æœŸ (Overdue)</span>
                        <span id="count-overdue" class="bg-red-900/50 px-2 rounded text-[10px]">0</span>
                    </h4>
                    <div id="list-overdue" class="space-y-3"></div>
                </div>
                
                <!-- æ€¥è¿«å€ -->
                <div id="section-upcoming" class="list-section hidden">
                    <h4 class="list-header text-bona-gold">
                        <span>ğŸ”¥ 2 é€±å…§ (Upcoming)</span>
                        <span id="count-upcoming" class="bg-yellow-900/50 px-2 rounded text-[10px]">0</span>
                    </h4>
                    <div id="list-upcoming" class="space-y-3"></div>
                </div>
                
                <!-- é å‘Šå€ -->
                <div id="section-future" class="list-section hidden">
                    <h4 class="list-header text-green-500">
                        <span>ğŸ“… 1 å€‹æœˆå…§ (Future)</span>
                        <span id="count-future" class="bg-green-900/50 px-2 rounded text-[10px]">0</span>
                    </h4>
                    <div id="list-future" class="space-y-3"></div>
                </div>
                
                <div id="butler-empty" class="text-center py-12 text-gray-600 text-xs hidden flex flex-col items-center">
                    <i class="fa-solid fa-check-circle text-4xl mb-3 text-gray-700"></i>
                    å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰æ€¥è¿«çš„æ›åœŸä»»å‹™
                </div>
            </main>

            <!-- TAB 3: LAB -->
            <main id="tab-content-lab" class="app-content hidden">
                <div class="p-6 glass-panel rounded-2xl text-center">
                    <h3 class="text-bona-gold text-lg font-bold mb-2">Bona Lab å¯¦é©—å®¤</h3>
                    <p class="text-gray-400 text-xs mb-4">æ•¸æ“šå°æ¨™åŠŸèƒ½é–‹ç™¼ä¸­...</p>
                    <a href="https://bonabeetle.com/lite" target="_blank" class="block w-full bg-white/10 py-2 rounded text-xs text-white">æŸ¥çœ‹ç™»å¤§èŸ²æ·»åŠ åŠ‘</a>
                </div>
            </main>

            <nav class="bottom-nav">
                <button onclick="switchTab('home')" id="nav-home" class="nav-item active-tab"><i class="fa-solid fa-crosshairs"></i><span>éŒ„å…¥</span></button>
                <button onclick="switchTab('butler')" id="nav-butler" class="nav-item"><i class="fa-solid fa-bell"></i><span>ç®¡å®¶</span></button>
                <button onclick="switchTab('lab')" id="nav-lab" class="nav-item"><i class="fa-solid fa-flask-vial"></i><span>å¯¦é©—å®¤</span></button>
            </nav>
        </div>

        <!-- VIEW: DETAIL -->
        <div id="view-detail" class="view-section z-20">
            <header class="fixed-header px-4 flex-row justify-between items-center" style="height: 80px; min-height: 80px;">
                <button onclick="closeDetail()" class="text-white text-xl p-2"><i class="fa-solid fa-arrow-left"></i></button>
                <span id="detail-id" class="text-bona-gold font-bold text-xl">--</span>
                <button onclick="showQR()" class="text-white text-xl p-2"><i class="fa-solid fa-qrcode"></i></button>
            </header>
            <main class="app-content pt-24">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="glass-panel p-4 rounded-xl">
                        <div class="text-gray-500 text-xs">é«”é‡</div>
                        <div class="text-white text-2xl font-bold"><span id="d-weight">--</span>g</div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl">
                        <div class="text-gray-500 text-xs">ä¸Šæ¬¡æ›åœŸ</div>
                        <div class="text-white text-lg font-bold" id="d-date">--</div>
                    </div>
                </div>
                <div class="glass-panel p-4 rounded-xl mb-4">
                     <div class="text-gray-500 text-xs mb-2">é£¼è‚²è³‡è¨Š</div>
                     <div class="text-white text-sm space-y-2">
                         <div class="flex justify-between border-b border-gray-700 pb-1"><span>å®¹å™¨</span><span id="d-box" class="text-white">--</span></div>
                         <div class="flex justify-between border-b border-gray-700 pb-1"><span>ä¸»é£Ÿ</span><span id="d-sub" class="text-white">--</span></div>
                         <div class="flex justify-between border-b border-gray-700 pb-1"><span>å‰¯é£Ÿ</span><span id="d-sub2" class="text-white">--</span></div>
                         <div class="flex justify-between"><span>æ·»åŠ </span><span id="d-boost" class="text-bona-gold font-bold">--</span></div>
                     </div>
                </div>
                <button onclick="openUpdateModal()" class="w-full gold-gradient text-black font-bold py-3 rounded-xl">æ›´æ–°æ•¸æ“š</button>
            </main>
        </div>

        <!-- MODALS (Simplified) -->
        <div id="modal-update" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-6">
            <div class="bg-zinc-900 w-full max-w-sm rounded-xl p-6 border border-gray-700">
                <h3 class="text-white font-bold mb-4">æ›´æ–°æ•¸æ“š</h3>
                <input type="hidden" id="update-id">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div><label class="text-xs text-gray-500">æ—¥æœŸ</label><input type="date" id="update-date" class="w-full bg-black border border-gray-600 rounded p-2 text-white"></div>
                    <div><label class="text-xs text-gray-500">é«”é‡ (g)</label><input type="number" id="update-weight" class="w-full bg-black border border-gray-600 rounded p-2 text-white"></div>
                </div>
                <!-- Simplified Update: Only essentials for quick update -->
                <div class="flex gap-2 mt-4">
                    <button onclick="closeModals()" class="flex-1 bg-gray-700 text-white py-3 rounded">å–æ¶ˆ</button>
                    <button onclick="submitUpdate()" class="flex-1 gold-gradient text-black font-bold py-3 rounded">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <div id="modal-qr" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-6">
            <div class="bg-white p-6 rounded-xl text-center">
                <div id="qrcode"></div>
                <button onclick="closeModals()" class="mt-4 text-black underline">é—œé–‰</button>
            </div>
        </div>

    </div>

    <script>
        // CONFIG
        const WEBHOOK_URL = "https://hook.us2.make.com/dft05gnm8d1nnhq1uw9owyy5rbon904w";
        let currentUser = localStorage.getItem('user_key');
        let currentDetail = {};
        
        // --- CORE FUNCTIONS ---
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(viewId);
            if(target) target.classList.add('active');
        }

        function switchTab(tabName) {
            ['home', 'butler', 'lab'].forEach(t => {
                document.getElementById(`tab-content-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('active-tab');
            });
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            document.getElementById(`nav-${tabName}`).classList.add('active-tab');
            
            if(tabName === 'butler') refreshTaskButler();
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').classList[show ? 'remove' : 'add']('hidden');
            if(show) document.getElementById('loading-overlay').style.display = 'flex';
        }

        function showNotif(msg) {
            const area = document.getElementById('notification-area');
            area.innerHTML = `<div class="bg-gray-800 text-white px-4 py-2 rounded border border-bona-gold shadow-lg text-xs font-bold text-center">${msg}</div>`;
            setTimeout(() => area.innerHTML = '', 3000);
        }

        function clean(val) {
            if(val === null || val === undefined) return '--';
            if(typeof val === 'object') {
                if(val.id && !val.date_check) return val.id; // Fallback
                return '--'; 
            }
            return val;
        }

        // --- AUTH ---
        async function handleLogin() {
            const key = document.getElementById('login-license').value.trim();
            if(!key) return showNotif('è«‹è¼¸å…¥æˆæ¬Šç¢¼');
            
            showLoading(true);
            try {
                const res = await fetch(WEBHOOK_URL, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'auth', userId: key })
                });
                
                if(res.ok) {
                    currentUser = key;
                    localStorage.setItem('user_key', key);
                    switchView('view-main');
                    switchTab('home');
                    showNotif('ç™»å…¥æˆåŠŸ');
                } else {
                    showNotif('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æˆæ¬Šç¢¼');
                }
            } catch(e) {
                showNotif('é€£ç·šéŒ¯èª¤');
                console.error(e);
            } finally {
                showLoading(false);
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // --- BUTLER LOGIC (Smart Sorting) ---
        async function refreshTaskButler() {
            showLoading(true);
            // Reset UI
            ['list-overdue', 'list-upcoming', 'list-future'].forEach(id => document.getElementById(id).innerHTML = '');
            ['section-overdue', 'section-upcoming', 'section-future', 'butler-empty'].forEach(id => document.getElementById(id).classList.add('hidden'));

            try {
                // Fetch ALL raw data (Flow log)
                const res = await fetch(WEBHOOK_URL, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'census', userId: currentUser })
                });
                
                const text = await res.text();
                let data = { items: [] };
                try { data = JSON.parse(text); } catch(e) {}
                
                let rawItems = data.items || data.data || [];
                
                if(rawItems.length === 0) {
                    document.getElementById('butler-empty').classList.remove('hidden');
                } else {
                    // 1. Deduplicate: Find latest record for each ID
                    const uniqueMap = {};
                    rawItems.forEach(item => {
                        // Compatible Key Mapping
                        const id = item.id || item.title || item.ID || 'Unknown';
                        const dateStr = item.date || item.date_check || item.Date_Check;
                        const date = new Date(dateStr);
                        
                        if(id !== 'Unknown' && !isNaN(date)) {
                            if(!uniqueMap[id] || date > new Date(uniqueMap[id].rawDate)) {
                                uniqueMap[id] = {
                                    id: id,
                                    rawDate: date,
                                    weight: item.weight || item.Weight || '--',
                                    box: `${item.box_type || item.Box_Type || '--'} ${item.box_vol || item.Box_Vol || ''}`,
                                    sub: `${item.sub_main || item.Sub_Main || '--'}`,
                                    sub2: item.sub_sec || item.Sub_Sec || '',
                                    boost: item.booster || item.Booster || '--'
                                };
                            }
                        }
                    });

                    // 2. Sort & Categorize
                    const today = new Date();
                    const CYCLE = 60; // Days
                    let countOver = 0, countUp = 0, countFut = 0;

                    Object.values(uniqueMap).sort((a, b) => a.rawDate - b.rawDate).forEach(bug => {
                        const nextDate = new Date(bug.rawDate);
                        nextDate.setDate(nextDate.getDate() + CYCLE);
                        const diffTime = nextDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        const html = createCard(bug, diffDays, nextDate.toISOString().split('T')[0]);

                        if(diffDays < 0) {
                            document.getElementById('list-overdue').innerHTML += html;
                            countOver++;
                        } else if(diffDays <= 14) {
                            document.getElementById('list-upcoming').innerHTML += html;
                            countUp++;
                        } else if(diffDays <= 30) {
                            document.getElementById('list-future').innerHTML += html;
                            countFut++;
                        }
                    });

                    // 3. Update Visibility
                    if(countOver > 0) {
                        document.getElementById('section-overdue').classList.remove('hidden');
                        document.getElementById('count-overdue').innerText = countOver;
                    }
                    if(countUp > 0) {
                        document.getElementById('section-upcoming').classList.remove('hidden');
                        document.getElementById('count-upcoming').innerText = countUp;
                    }
                    if(countFut > 0) {
                        document.getElementById('section-future').classList.remove('hidden');
                        document.getElementById('count-future').innerText = countFut;
                    }
                    if(countOver + countUp + countFut === 0) {
                        document.getElementById('butler-empty').classList.remove('hidden');
                        document.getElementById('butler-empty').innerText = "å¤ªæ£’äº†ï¼æœªä¾† 30 å¤©å…§æ²’æœ‰æ›åœŸä»»å‹™";
                    }
                }
            } catch(e) {
                console.error(e);
                showNotif('åŒæ­¥å¤±æ•—');
            } finally {
                showLoading(false);
            }
        }

        function createCard(bug, days, nextDateStr) {
            let badgeClass = 'bg-gray-700 text-gray-300';
            let label = `å‰© ${days} å¤©`;
            let borderClass = 'border-gray-700';

            if(days < 0) {
                badgeClass = 'bg-red-900 text-red-200';
                label = `é€¾æœŸ ${Math.abs(days)} å¤©`;
                borderClass = 'border-red-900';
            } else if(days <= 14) {
                badgeClass = 'bg-yellow-900 text-yellow-200';
                borderClass = 'border-yellow-900';
            } else {
                badgeClass = 'bg-green-900 text-green-200';
                borderClass = 'border-green-900';
            }

            return `
                <div class="glass-panel p-4 rounded-xl border-l-4 ${borderClass} relative">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-white font-bold text-lg font-mono">${bug.id}</div>
                        <span class="text-[10px] px-2 py-1 rounded ${badgeClass} font-bold">${label}</span>
                    </div>
                    <div class="text-xs text-gray-400 grid grid-cols-2 gap-1 mb-2">
                        <div>é‡: <span class="text-white">${bug.weight}g</span></div>
                        <div>${bug.box}</div>
                        <div class="col-span-2 text-gray-500">${bug.sub} ${bug.sub2 ? '+'+bug.sub2 : ''}</div>
                        <div class="col-span-2 text-bona-gold">${bug.boost !== '--' ? 'â˜… '+bug.boost : ''}</div>
                    </div>
                    <div class="flex justify-between items-center border-t border-gray-700 pt-2 mt-2">
                        <span class="text-[10px] text-gray-600">é è¨ˆ: ${nextDateStr}</span>
                        <button onclick="fetchDetail('${bug.id}')" class="text-[10px] border border-bona-gold text-bona-gold px-3 py-1 rounded hover:bg-bona-gold hover:text-black">æ›´æ–°</button>
                    </div>
                </div>
            `;
        }

        // --- FETCH SINGLE DETAIL ---
        async function fetchDetail(id) {
            if (!currentUser) return showNotif('è«‹å…ˆç™»å…¥');
            showLoading(true);
            try {
                const res = await fetch(WEBHOOK_URL, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type: 'query', id: id, userId: currentUser })
                });
                const text = await res.text();
                let data = JSON.parse(text);
                
                // Parse items array logic same as butler but strict for 1
                let record = {};
                let history = [];
                
                if(data.items && data.items.length > 0) history = data.items;
                else if(data.data) history = data.data;
                else if(Array.isArray(data)) history = data;
                
                // Sort Descending
                history.sort((a,b) => new Date(b.date || b.date_check) - new Date(a.date || a.date_check));
                
                if(history.length > 0) {
                    record = history[0]; // Latest
                    currentDetail = record; // Store for update
                    
                    // Render Detail View
                    document.getElementById('detail-id').innerText = record.id || record.title || id;
                    document.getElementById('d-weight').innerText = record.weight || '--';
                    document.getElementById('d-date').innerText = (record.date || record.date_check || '').split('T')[0];
                    document.getElementById('d-sub').innerText = `ä¸»: ${record.sub_main || '--'}`;
                    document.getElementById('d-sub2').innerText = `å‰¯: ${record.sub_sec || '--'}`;
                    document.getElementById('d-box').innerText = `${record.box_type||''} ${record.box_vol||''}`;
                    document.getElementById('d-boost').innerText = record.booster || '--';
                    
                    // Setup Update Modal hidden fields
                    document.getElementById('update-id').value = id;

                    switchView('view-detail');
                } else {
                    showNotif('æ‰¾ä¸åˆ°è©³ç´°è³‡æ–™');
                }
            } catch(e) {
                console.error(e);
                showNotif('è®€å–å¤±æ•—');
            } finally {
                showLoading(false);
            }
        }
        
        // --- UPDATE LOGIC ---
        function openUpdateModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('update-date').value = today;
            document.getElementById('modal-update').classList.remove('hidden');
            document.getElementById('modal-update').classList.add('flex');
        }

        function closeModals() {
            document.querySelectorAll('[id^="modal-"]').forEach(e => {
                e.classList.add('hidden');
                e.classList.remove('flex');
            });
        }
        
        // Mock functions for other buttons to prevent crash
        function openScanner() { showNotif('æƒæåŠŸèƒ½ (Placeholder)'); }
        function showNewEntryForm() { showNotif('éŒ„å…¥åŠŸèƒ½ (Placeholder)'); }
        function handleManualSearch() { fetchDetail(document.getElementById('search-id').value.toUpperCase()); }
        function showQR() { showNotif('QR Code (Placeholder)'); }
        function closeDetail() { switchView('view-main'); }
        async function submitUpdate() { showNotif('æ›´æ–°åŠŸèƒ½ (Placeholder)'); closeModals(); }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            if(currentUser) {
                switchView('view-main');
                switchTab('home');
            } else {
                switchView('view-login');
            }
        });

    </script>
</body>
</html>