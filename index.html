<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BONA BEETLE PRO | 專業數位資產管理</title>
    
    <!-- 引用樣式與函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        :root {
            --accent-gold: #d4af37;
            --bg-dark: #0f0f0f;
            --card-gray: #1a1a1a;
            --notion-blue: #2563eb;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-dark); color: #e5e7eb; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(26, 26, 26, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tab-active { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); }
        .btn-primary { background: var(--accent-gold); color: black; font-weight: bold; }
        .btn-outline { border: 1px solid var(--accent-gold); color: var(--accent-gold); }
        input, select, textarea { background: #262626; border: 1px solid #333; color: white; border-radius: 8px; padding: 12px; outline: none; }
        input:focus, select:focus { border-color: var(--accent-gold); }
        .safe-area-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 80px); }
        label { font-size: 0.75rem; color: #9ca3af; font-weight: 500; margin-bottom: 0.25rem; display: block; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background: #10b981; box-shadow: 0 0 8px #10b981; animation: pulse 2s infinite; }
        .status-offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .status-warning { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        #login-overlay { position: fixed; inset: 0; background: var(--bg-dark); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; }
        
        #demo-banner { display: none; background: #92400e; color: #fef3c7; text-align: center; font-size: 10px; padding: 4px; font-weight: bold; letter-spacing: 1px; }
    </style>
</head>
<body class="min-h-screen">

    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-gold border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gold font-bold italic tracking-widest" id="loading-text">數據同步中...</p>
    </div>

    <!-- 1. 授權登入介面 -->
    <div id="login-overlay">
        <img src="logo.png" alt="Bona Logo" onerror="this.src='https://via.placeholder.com/100/d4af37/000000?text=B'" class="w-24 h-24 mb-6 rounded-2xl shadow-2xl">
        <h1 class="text-2xl font-bold mb-2">BONA <span class="text-[var(--accent-gold)]">PRO</span></h1>
        <p class="text-gray-500 text-sm mb-8 text-center px-6">輸入授權碼並驗證 API 金鑰以啟動系統</p>
        <div class="w-full max-w-xs space-y-4">
            <input type="text" id="license-input" placeholder="XXXX-XXXX-XXXX" class="w-full text-center tracking-widest uppercase font-mono">
            <button onclick="handleLogin()" class="btn-primary w-full py-4 rounded-xl shadow-lg active:scale-95 transition-all">驗證並進入系統</button>
        </div>
    </div>

    <!-- 2. 掃描標籤視窗 -->
    <div id="scanner-modal" class="fixed inset-0 bg-black z-[100] hidden flex-col">
        <div class="p-6 flex justify-between items-center bg-zinc-900">
            <h2 class="font-bold text-[var(--accent-gold)]">標籤掃描器</h2>
            <button onclick="stopScanner()" class="text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="reader" class="flex-1"></div>
    </div>

    <div id="demo-banner">目前運行於展示模式 - Webhook 驗證失敗或連結失效</div>

    <!-- Header -->
    <header id="main-header" class="p-4 sticky top-0 z-50 glass-card flex justify-between items-center hidden">
        <div class="flex items-center gap-3">
            <img src="logo.png" alt="Bona Logo" class="w-10 h-10 rounded-lg">
            <div>
                <h1 class="text-lg font-bold">BONA <span class="text-[var(--accent-gold)]">PRO</span></h1>
                <div class="flex items-center gap-1.5">
                    <div id="connection-status-dot" class="status-dot status-online"></div>
                    <p id="connection-status-text" class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">System Online</p>
                </div>
            </div>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-gray-500 uppercase">授權方案</p>
            <p class="text-xs font-mono font-bold text-gold">ELITE MEMBER</p>
        </div>
    </header>

    <main id="main-content" class="p-4 safe-area-bottom space-y-6 hidden">
        <nav class="flex justify-around border-b border-gray-800 text-sm overflow-x-auto whitespace-nowrap">
            <button onclick="switchView('dashboard')" id="tab-dashboard" class="px-3 py-2 tab-active">儀表板</button>
            <button onclick="switchView('records')" id="tab-records" class="px-3 py-2 text-gray-500">快速紀錄</button>
            <button onclick="switchView('growth')" id="tab-growth" class="px-3 py-2 text-gray-500">生長曲線</button>
            <button onclick="switchView('individuals')" id="tab-individuals" class="px-3 py-2 text-gray-500">個體入庫</button>
            <button onclick="switchView('batches')" id="tab-batches" class="px-3 py-2 text-gray-500">批次管理</button>
        </nav>

        <!-- View 1: 儀表板 -->
        <section id="view-dashboard" class="space-y-4">
            <div class="grid grid-cols-3 gap-3">
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-gray-500">待換土</p>
                    <p class="text-xl font-bold text-red-500" id="stat-pending">--</p>
                </div>
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-gray-500">S級個體</p>
                    <p class="text-xl font-bold text-yellow-500" id="stat-elite">--</p>
                </div>
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-gray-500">本月入庫</p>
                    <p class="text-xl font-bold text-blue-500" id="stat-monthly">--</p>
                </div>
            </div>
            
            <div class="glass-card p-4 rounded-2xl border-l-4 border-gold">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold flex items-center gap-2"><i data-lucide="bell" class="w-4 h-4 text-yellow-500"></i> 智慧管家提醒</h3>
                    <button onclick="syncFromNotion()" class="text-[10px] text-gray-400 border border-gray-700 px-2 py-0.5 rounded">刷新數據</button>
                </div>
                <div id="butler-list" class="space-y-2">
                    <div class="p-3 bg-white/5 rounded-lg text-center text-xs text-gray-500 italic">載入中...</div>
                </div>
            </div>
        </section>

        <!-- View 2: 快速紀錄 -->
        <section id="view-records" class="hidden space-y-4">
            <div class="glass-card p-5 rounded-2xl space-y-5">
                <div class="flex justify-between items-center">
                    <h2 class="font-bold text-lg">快速日誌 (Log)</h2>
                    <button onclick="startScanner()" class="text-xs btn-outline px-3 py-1.5 rounded-full"><i class="fa-solid fa-qrcode mr-1"></i>掃描標籤</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label>個體 ID</label>
                        <select id="specimen-id-select" class="w-full text-sm">
                            <option value="">請選定個體...</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label>當前狀態</label>
                            <select id="mode-select-log" class="w-full text-sm"></select>
                        </div>
                        <div>
                            <label>重量 (g)</label>
                            <input type="number" id="log-weight" step="0.1" placeholder="0.0" class="w-full">
                        </div>
                    </div>
                    <div class="p-4 bg-white/5 rounded-xl border border-gray-800 space-y-3">
                        <p class="text-[10px] text-yellow-500 font-bold uppercase tracking-widest pb-1 border-b border-gray-800">耗材與環境紀錄</p>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label>主食材</label>
                                <select id="sub-main-select" class="text-xs w-full"></select>
                            </div>
                            <div>
                                <label>容器體積</label>
                                <select id="box-vol-select" class="text-xs w-full"></select>
                            </div>
                        </div>
                        <div>
                            <label>添加量 (Booster)</label>
                            <select id="booster-select" class="text-xs w-full"></select>
                        </div>
                    </div>
                    <button onclick="submitLog()" class="btn-primary w-full py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="send" class="w-4 h-4"></i> 同步至 Notion
                    </button>
                </div>
            </div>
        </section>

        <!-- View 3: 生長曲線 -->
        <section id="view-growth" class="hidden space-y-4">
            <div class="glass-card p-5 rounded-2xl space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="font-bold text-lg">數據曲線分析</h2>
                    <i class="fa-solid fa-chart-line text-yellow-500"></i>
                </div>
                <select id="chart-specimen-select" onchange="updateGrowthChart()" class="w-full text-sm">
                    <option value="">請選定個體...</option>
                </select>
                <div class="chart-container bg-black/20 rounded-xl p-2 border border-gray-800">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </section>

        <!-- View 4: 個體入庫 -->
        <section id="view-individuals" class="hidden space-y-4">
            <div class="glass-card p-5 rounded-2xl space-y-5">
                <h2 class="font-bold text-lg">新個體批量入庫</h2>
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2">
                        <label>歸屬批次</label>
                        <select id="batch-select" onchange="previewID()" class="w-full text-sm"></select>
                    </div>
                    <div class="col-span-1">
                        <label>數量</label>
                        <input type="number" id="input-quantity" value="1" min="1" oninput="previewID()" class="w-full text-center font-bold">
                    </div>
                </div>
                <div class="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-yellow-500 font-bold uppercase">預覽編碼</p>
                        <p id="id-preview-range" class="text-sm font-mono font-bold text-white">---</p>
                    </div>
                    <button onclick="fetchNextSerial()" class="text-[10px] text-blue-400 underline">檢查序號</button>
                </div>
                <button onclick="handleOnboarding()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> 啟動自動編碼入庫
                </button>
            </div>
        </section>

        <!-- View 5: 批次管理 -->
        <section id="view-batches" class="hidden space-y-4">
            <div id="batch-list-container" class="space-y-3">
                <div class="p-8 text-center text-gray-500 text-xs">載入中...</div>
            </div>
        </section>
    </main>

    <footer id="main-footer" class="fixed bottom-0 left-0 right-0 glass-card p-4 border-t border-gray-800 flex justify-around items-center hidden">
        <button onclick="switchView('dashboard')" id="btn-dashboard" class="flex flex-col items-center gap-1 text-gold"><i class="fa-solid fa-house text-lg"></i><span class="text-[8px]">儀表板</span></button>
        <button onclick="switchView('records')" id="btn-records" class="flex flex-col items-center gap-1 text-gray-500"><i class="fa-solid fa-plus-circle text-lg"></i><span class="text-[8px]">快速紀錄</span></button>
        <button onclick="switchView('growth')" id="btn-growth" class="flex flex-col items-center gap-1 text-gray-500"><i class="fa-solid fa-chart-line text-lg"></i><span class="text-[8px]">生長曲線</span></button>
        <button onclick="switchView('individuals')" id="btn-individuals" class="flex flex-col items-center gap-1 text-gray-500"><i class="fa-solid fa-beetle text-lg"></i><span class="text-[8px]">個體入庫</span></button>
        <button onclick="switchView('batches')" id="btn-batches" class="flex flex-col items-center gap-1 text-gray-500"><i class="fa-solid fa-layer-group text-lg"></i><span class="text-[8px]">批次設定</span></button>
    </footer>

    <script>
        // --- PRO 自動化配置 ---
        const PRO_WEBHOOK_URL = "https://hook.us2.make.com/3t09tt0d685yi05vfbfjqha01l4mg4pu";
        const MAKE_API_KEY = "BonaPro-Safe-19790514"; 

        const DICT = {
            modes: ["卵", "L1", "L2", "L3前期", "L3中期", "L3後期", "化蛹", "成功羽化", "羽化失敗"],
            subMain: ["BONA木屑", "AKD木屑", "BEVO木屑", "P2木屑", "雲芝菌", "育成土", "AD完熟木屑", "其他"],
            boosters: ["無添加", "10g/10L", "20g/10L", "極限組"],
            boxVols: ["500mL", "1000mL", "1400mL", "2300mL", "4L", "6L", "8L", "其他"]
        };

        let currentChart = null;

        function initData() {
            populateSelect('mode-select-log', DICT.modes, "目前狀態");
            populateSelect('sub-main-select', DICT.subMain, "主食材");
            populateSelect('booster-select', DICT.boosters, "添加量");
            populateSelect('box-vol-select', DICT.boxVols, "體積");
            if (window.lucide) lucide.createIcons();
            syncFromNotion();
        }

        /**
         * 統一 Webhook 通訊函式 (增強對純文字回傳如 "Accepted" 的解析處理)
         */
        async function callWebhook(action, payload) {
            const license = localStorage.getItem('license');
            const data = { action, license, ...payload };
            console.log(`[Webhook Call] ${action}`, data);

            try {
                const response = await fetch(PRO_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-make-apikey': MAKE_API_KEY 
                    },
                    body: JSON.stringify(data),
                    mode: 'cors'
                });
                
                if (response.status === 410) {
                    updateStatus('offline', 'Webhook 已失效 (410)');
                    return handleFallback(action);
                }

                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                // 先讀取文字，嘗試判斷是否為 JSON
                const responseText = await response.text();
                let result;
                
                try {
                    result = JSON.parse(responseText);
                } catch (jsonError) {
                    // 如果不是 JSON (例如 Make 回傳 "Accepted")，封裝成基本物件
                    console.log(`[Webhook Info] Non-JSON response received: ${responseText}`);
                    result = { success: true, message: responseText };
                }

                updateStatus('online');
                return result;
            } catch (e) {
                console.error(`[Webhook Error] ${action}:`, e);
                updateStatus('warning', '連線異常');
                return handleFallback(action);
            }
        }

        /**
         * 備用模擬數據邏輯
         */
        function handleFallback(action) {
            document.getElementById('demo-banner').style.display = 'block';
            if (action === "SYNC_DATA") {
                return {
                    stats: { pending: 15, elite: 8, monthly: 42 },
                    specimens: [
                        { value: "DEMO-01", text: "DHH-2026-B01-05 (展示數據)" },
                        { value: "DEMO-02", text: "DTS-2026-B01-01 (展示數據)" }
                    ],
                    batches: [{ value: "DHH-2026-B01", text: "2026-DHH-B01 (展示)" }],
                    alerts: [{ id: "DEMO-01", text: "注意：Webhook 目前傳回純文字狀態，若需真實數據請調整 Make 配置。" }]
                };
            }
            if (action === "GET_NEXT_SERIAL") return { nextSerial: 1 };
            return null;
        }

        function updateStatus(state, msg) {
            const dot = document.getElementById('connection-status-dot');
            const text = document.getElementById('connection-status-text');
            if (!dot || !text) return;
            dot.className = "status-dot";
            if (state === 'online') {
                dot.classList.add('status-online');
                text.innerText = "System Online";
                text.className = "text-[9px] text-green-400 font-bold uppercase tracking-widest";
                document.getElementById('demo-banner').style.display = 'none';
            } else if (state === 'warning') {
                dot.classList.add('status-warning');
                text.innerText = msg || "Connection Warning";
                text.className = "text-[9px] text-amber-400 font-bold uppercase tracking-widest";
            } else {
                dot.classList.add('status-offline');
                text.innerText = msg || "System Offline";
                text.className = "text-[9px] text-red-400 font-bold uppercase tracking-widest";
            }
        }

        async function submitLog() {
            const specimenId = document.getElementById('specimen-id-select').value;
            const mode = document.getElementById('mode-select-log').value;
            const weight = document.getElementById('log-weight').value;
            const subMain = document.getElementById('sub-main-select').value;
            const booster = document.getElementById('booster-select').value;
            if(!specimenId) return alert("請選定個體！");
            showLoading(true, "數據同步至 Notion...");
            const result = await callWebhook("SUBMIT_LOG", { specimenId, mode, weight, subMain, booster, timestamp: new Date().toISOString() });
            showLoading(false);
            if(result) {
                alert("✅ 紀錄已成功提交！");
                document.getElementById('log-weight').value = "";
            }
        }

        async function fetchNextSerial() {
            const batchId = document.getElementById('batch-select').value;
            if(!batchId) return alert("請先選擇批次");
            showLoading(true, "查詢序號...");
            const result = await callWebhook("GET_NEXT_SERIAL", { batchId });
            showLoading(false);
            if(result && result.nextSerial !== undefined) {
                localStorage.setItem('next_serial_' + batchId, result.nextSerial);
                previewID();
            }
        }

        async function handleOnboarding() {
            const batchId = document.getElementById('batch-select').value;
            const qty = document.getElementById('input-quantity').value;
            if(!batchId) return alert("請選擇批次");
            showLoading(true, `生成 ${qty} 筆資產...`);
            const result = await callWebhook("BATCH_ONBOARD", { batchId, quantity: qty });
            showLoading(false);
            if(result) {
                alert("✅ 入庫指令已發出！");
                switchView('dashboard');
                syncFromNotion();
            }
        }

        async function syncFromNotion() {
            showLoading(true, "讀取 Notion 數據...");
            const result = await callWebhook("SYNC_DATA", {});
            showLoading(false);
            
            // 如果結果有效且不是模擬數據，則嘗試更新介面
            if(result) {
                if(result.stats) {
                    document.getElementById('stat-pending').innerText = result.stats.pending || 0;
                    document.getElementById('stat-elite').innerText = result.stats.elite || 0;
                    document.getElementById('stat-monthly').innerText = result.stats.monthly || 0;
                }
                
                if(result.specimens) {
                    populateSelect('specimen-id-select', result.specimens, "選擇個體");
                    populateSelect('chart-specimen-select', result.specimens, "選擇分析個體");
                }
                if(result.batches) populateSelect('batch-select', result.batches, "選取批次");
                
                if(result.alerts) {
                    const list = document.getElementById('butler-list');
                    list.innerHTML = result.alerts.map(a => `
                        <div class="p-3 bg-red-900/10 rounded-lg flex justify-between items-center border border-red-900/20">
                            <span class="text-[11px]">${a.text}</span>
                            <button onclick="handleButlerAction('${a.id}')" class="text-[10px] bg-red-500 text-white px-2 py-1 rounded">查看</button>
                        </div>
                    `).join('') || '<p class="text-center text-xs text-gray-500">目前暫無提醒</p>';
                }
            }
        }

        function showLoading(show, text) {
            const el = document.getElementById('loading-overlay');
            if(text) document.getElementById('loading-text').innerText = text;
            el.style.display = show ? 'flex' : 'none';
        }

        function handleLogin() {
            const input = document.getElementById('license-input').value;
            if (input.length > 3) {
                localStorage.setItem('license', input);
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('main-footer').classList.remove('hidden');
                initData();
            } else {
                alert("授權碼驗證失敗");
            }
        }

        function switchView(viewId) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById('view-' + viewId);
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('footer button').forEach(b => {
                b.classList.remove('text-gold'); b.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById('btn-' + viewId);
            if(activeBtn) { activeBtn.classList.add('text-gold'); activeBtn.classList.remove('text-gray-500'); }
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active', 'text-gray-500');
                if (b.id === 'tab-' + viewId) b.classList.add('tab-active');
                else b.classList.add('text-gray-500');
            });
            if (viewId === 'growth') {
                setTimeout(() => { if (!currentChart) initGrowthChart(); else currentChart.resize(); }, 100);
            }
        }

        function populateSelect(id, options, placeholder) {
            const el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = `<option value="">-- ${placeholder} --</option>`; 
            options.forEach(opt => {
                const o = document.createElement('option');
                if (typeof opt === 'string') { o.value = opt; o.innerText = opt; }
                else { o.value = opt.value; o.innerText = opt.text; }
                el.appendChild(o);
            });
        }

        function previewID() {
            const batch = document.getElementById('batch-select').value;
            const qty = parseInt(document.getElementById('input-quantity').value) || 0;
            const range = document.getElementById('id-preview-range');
            if(!batch || qty <= 0) { range.innerText = "---"; return; }
            const start = parseInt(localStorage.getItem('next_serial_' + batch)) || 1;
            const end = start + qty - 1;
            const fmt = (n) => n < 10 ? "0"+n : n;
            range.innerText = qty === 1 ? `${batch}-${fmt(start)}` : `${batch}-${fmt(start)} ~ ${fmt(end)}`;
        }

        function initGrowthChart() {
            const canvas = document.getElementById('growthChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (currentChart) currentChart.destroy();
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                    datasets: [{
                        data: [5, 25, 65, 95, 115, 138],
                        borderColor: '#d4af37',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(212, 175, 55, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function updateGrowthChart() {
            if (!currentChart) initGrowthChart();
            const specimen = document.getElementById('chart-specimen-select').value;
            if (specimen.includes('01')) {
                currentChart.data.datasets[0].data = [8, 30, 75, 105, 125, 145];
            } else {
                currentChart.data.datasets[0].data = [5, 25, 65, 95, 115, 138];
            }
            currentChart.update();
        }

        function startScanner() {
            document.getElementById('scanner-modal').style.display = 'flex';
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (id) => {
                const sel = document.getElementById('specimen-id-select');
                if (!Array.from(sel.options).some(o => o.value === id)) sel.innerHTML += `<option value="${id}">${id}</option>`;
                sel.value = id;
                html5QrCode.stop().then(() => { document.getElementById('scanner-modal').style.display = 'none'; });
                switchView('records');
            }).catch(err => {
                console.error("Scanner Error", err);
                alert("無法啟動相機。");
                stopScanner();
            });
        }

        function stopScanner() { document.getElementById('scanner-modal').style.display = 'none'; }

        function handleButlerAction(id) {
            switchView('records');
            const sel = document.getElementById('specimen-id-select');
            if (!Array.from(sel.options).some(o => o.value === id)) sel.innerHTML += `<option value="${id}">${id}</option>`;
            sel.value = id;
        }

        window.onload = () => {
            const savedLicense = localStorage.getItem('license');
            if(savedLicense) {
                document.getElementById('license-input').value = savedLicense;
                handleLogin();
            }
        };
    </script>
</body>
</html>