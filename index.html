<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BONA BEETLE PRO | 專業數位資產管理</title>
    
    <!-- 引用樣式與函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        :root {
            --accent-gold: #d4af37;
            --bg-dark: #0f0f0f;
            --card-gray: #1a1a1a;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-dark); color: #e5e7eb; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(26, 26, 26, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .tab-active { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); }
        .btn-primary { background: var(--accent-gold); color: black; font-weight: bold; }
        .btn-blue { background: #2563eb; color: white; font-weight: bold; }
        input, select, textarea { background: #262626; border: 1px solid #333; color: white; border-radius: 8px; padding: 12px; outline: none; }
        input:focus, select:focus { border-color: var(--accent-gold); }
        .safe-area-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 80px); }
        label { font-size: 0.75rem; color: #9ca3af; font-weight: 500; margin-bottom: 0.25rem; display: block; }
        .text-gold { color: var(--accent-gold) !important; }

        /* Scanner Modal */
        #scanner-modal { display: none; position: fixed; inset: 0; background: black; z-index: 100; flex-direction: column; }
        #reader { width: 100% !important; height: 70vh !important; }
    </style>
</head>
<body class="min-h-screen">

    <!-- 掃描標籤視窗 (Scanner Modal) -->
    <div id="scanner-modal">
        <div class="p-6 flex justify-between items-center bg-zinc-900">
            <h2 class="font-bold text-gold">掃描個體標籤</h2>
            <button onclick="stopScanner()" class="text-white text-xl"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="reader"></div>
        <div class="p-8 text-center text-gray-400 text-sm">
            請將 QR Code 對準鏡頭中央進行自動識別
        </div>
    </div>

    <!-- Top Navigation -->
    <header class="p-4 sticky top-0 z-50 glass-card flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="logo.png" alt="Bona Logo" onerror="this.src='https://via.placeholder.com/40/d4af37/000000?text=B'" class="w-10 h-10 rounded-lg">
            <div>
                <h1 class="text-lg font-bold">BONA <span style="color:var(--accent-gold)">PRO</span></h1>
                <p class="text-[10px] text-gray-500 tracking-widest uppercase">Elite Breeder System</p>
            </div>
        </div>
        <div class="flex gap-4 items-center">
            <button class="relative"><i class="fa-solid fa-bell text-gray-400"></i><span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></span></button>
            <i class="fa-solid fa-circle-user text-2xl text-gray-600"></i>
        </div>
    </header>

    <main class="p-4 safe-area-bottom space-y-6">
        
        <!-- Tab Menu -->
        <nav class="flex justify-around border-b border-gray-800 text-sm overflow-x-auto whitespace-nowrap">
            <button onclick="switchView('dashboard')" id="tab-dashboard" class="px-4 py-2 tab-active">儀表板</button>
            <button onclick="switchView('records')" id="tab-records" class="px-4 py-2 text-gray-500">快速紀錄</button>
            <button onclick="switchView('individuals')" id="tab-individuals" class="px-4 py-2 text-gray-500">個體入庫</button>
            <button onclick="switchView('batches')" id="tab-batches" class="px-4 py-2 text-gray-500">批次管理</button>
        </nav>

        <!-- 1. 儀表板 (Dashboard) -->
        <section id="view-dashboard" class="space-y-4">
            <div class="grid grid-cols-3 gap-3">
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-gray-500">待換土</p>
                    <p class="text-xl font-bold text-red-500">8</p>
                </div>
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-gray-500">S級個體</p>
                    <p class="text-xl font-bold text-yellow-500">12</p>
                </div>
                <div class="glass-card p-3 rounded-xl text-center">
                    <p class="text-[10px] text-gray-500">育種中</p>
                    <p class="text-xl font-bold text-blue-500">4</p>
                </div>
            </div>

            <!-- 可點擊處理的智慧管家 -->
            <div class="glass-card p-4 rounded-2xl">
                <h3 class="text-sm font-bold mb-3 flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i> 智慧管家建議</h3>
                <div class="space-y-2">
                    <div class="p-3 bg-white/5 rounded-lg flex justify-between items-center">
                        <span class="text-xs">DHH-2024-B01-08 已逾 60 天未更換木屑</span>
                        <button onclick="handleButlerAction('DHH-2024-B01-08')" class="text-[10px] bg-red-900/40 text-red-400 px-3 py-1.5 rounded-lg border border-red-800/50 active:scale-95 transition-all">立即換土</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. 快速紀錄 (Log) -->
        <section id="view-records" class="hidden space-y-4">
            <div class="glass-card p-5 rounded-2xl space-y-5">
                <div class="flex justify-between items-center">
                    <h2 class="font-bold text-lg">新增飼育日誌</h2>
                    <button onclick="startScanner()" class="text-xs text-gold border border-gold/30 px-3 py-1.5 rounded-full bg-gold/5 active:scale-95 transition-all">
                        <i class="fa-solid fa-qrcode mr-1"></i>掃描標籤
                    </button>
                </div>
                
                <div class="flex flex-col gap-4">
                    <div>
                        <label>個體 ID</label>
                        <select id="specimen-id-select" class="w-full">
                            <option value="">請選擇或掃描標籤...</option>
                            <option value="DHH-2024-B01-08">DHH-2024-B01-08 (今日建議)</option>
                            <option value="DHH-2026-B01-01">DHH-2026-B01-01</option>
                            <option value="DHH-2026-B01-02">DHH-2026-B01-02</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label>紀錄狀態</label>
                            <select id="mode-select-log" class="w-full"></select>
                        </div>
                        <div>
                            <label>重量 (g)</label>
                            <input type="number" step="0.1" placeholder="0.0" class="w-full">
                        </div>
                    </div>
                    <button class="btn-primary w-full py-4 rounded-xl shadow-lg active:scale-95">提交單筆紀錄</button>
                </div>
            </div>
        </section>

        <!-- 3. 個體入庫 (Smart Onboarding) -->
        <section id="view-individuals" class="hidden space-y-4">
            <div class="glass-card p-5 rounded-2xl space-y-5">
                <h2 class="font-bold text-lg">新個體入庫 (批量生成)</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <div class="col-span-2">
                            <label>選取批次</label>
                            <select id="batch-select" onchange="previewID()" class="w-full text-sm">
                                <option value="">請選擇...</option>
                                <option value="DHH-2026-B01">2026-DHH-B01 (長戟)</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label>數量</label>
                            <input type="number" id="input-quantity" value="1" min="1" oninput="previewID()" class="w-full text-center font-bold">
                        </div>
                    </div>

                    <div class="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[10px] text-yellow-500 font-bold uppercase">預計生成 ID 區間</p>
                                <p id="id-preview-range" class="text-lg font-mono font-bold tracking-tight">---</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-gray-500 font-bold">總筆數</p>
                                <p id="total-count-preview" class="text-lg font-bold">--</p>
                            </div>
                        </div>
                    </div>

                    <button class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">啟動批量入庫</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Bottom Nav -->
    <footer class="fixed bottom-0 left-0 right-0 glass-card p-4 border-t border-gray-800 flex justify-around items-center">
        <button onclick="switchView('dashboard')" id="btn-dashboard" class="flex flex-col items-center gap-1 text-gold"><i class="fa-solid fa-house"></i><span class="text-[8px]">儀表板</span></button>
        <button onclick="switchView('records')" id="btn-records" class="flex flex-col items-center gap-1 text-gray-500"><i class="fa-solid fa-plus-circle"></i><span class="text-[8px]">快速紀錄</span></button>
        <button onclick="switchView('individuals')" id="btn-individuals" class="flex flex-col items-center gap-1 text-gray-500"><i class="fa-solid fa-beetle"></i><span class="text-[8px]">個體入庫</span></button>
        <button onclick="switchView('batches')" id="btn-batches" class="flex flex-col items-center gap-1 text-gray-500"><i class="fa-solid fa-layer-group"></i><span class="text-[8px]">批次設定</span></button>
    </footer>

    <script>
        const DICT = {
            modes: ["卵", "L1", "L2", "L3前期", "L3中期", "L3後期", "化蛹", "成功羽化", "羽化失敗"],
        };

        let html5QrCode;

        function initData() {
            populateSelect('mode-select-log', DICT.modes, "狀態");
            if (window.lucide) lucide.createIcons();
        }

        function populateSelect(id, options, placeholder) {
            const el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = `<option value="">-- ${placeholder} --</option>`; 
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt; o.innerText = opt; el.appendChild(o);
            });
        }

        /**
         * 掃描功能啟動
         */
        function startScanner() {
            document.getElementById('scanner-modal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                console.log("掃描成功:", decodedText);
                // 處理掃描到的 ID
                processScannedID(decodedText);
                stopScanner();
            }).catch(err => {
                console.warn("掃描器啟動失敗:", err);
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-modal').style.display = 'none';
                }).catch(err => console.error(err));
            } else {
                document.getElementById('scanner-modal').style.display = 'none';
            }
        }

        /**
         * 處理掃描到的 ID 並填入表單
         */
        function processScannedID(id) {
            // 切換到紀錄分頁
            switchView('records');
            
            // 嘗試在選單中選中該 ID
            const select = document.getElementById('specimen-id-select');
            
            // 如果 ID 不在預設選項中，動態新增一個
            let exists = Array.from(select.options).some(opt => opt.value === id);
            if (!exists) {
                const newOpt = document.createElement('option');
                newOpt.value = id;
                newOpt.text = id + " (掃描成功)";
                select.appendChild(newOpt);
            }
            select.value = id;
            
            // 震動回饋 (如果手機支援)
            if (window.navigator.vibrate) window.navigator.vibrate(100);
        }

        /**
         * 處理智慧管家「立即換土」動作
         */
        function handleButlerAction(id) {
            processScannedID(id);
            // 自動選定狀態為「L3 中期」(可根據訊息邏輯微調)
            const modeSelect = document.getElementById('mode-select-log');
            if (modeSelect) modeSelect.value = "L3中期";
        }

        function switchView(viewId) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById('view-' + viewId);
            if(target) target.classList.remove('hidden');

            document.querySelectorAll('footer button').forEach(b => {
                b.classList.remove('text-gold'); b.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById('btn-' + viewId);
            if(activeBtn) { activeBtn.classList.add('text-gold'); activeBtn.classList.remove('text-gray-500'); }
            
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('tab-active', 'text-gray-500');
                if (b.id === 'tab-' + viewId) b.classList.add('tab-active');
                else b.classList.add('text-gray-500');
            });
        }

        function previewID() {
            const batch = document.getElementById('batch-select').value;
            const qty = parseInt(document.getElementById('input-quantity').value) || 0;
            const previewRange = document.getElementById('id-preview-range');
            const totalPreview = document.getElementById('total-count-preview');

            if(!batch || qty <= 0) {
                previewRange.innerText = "---";
                totalPreview.innerText = "--";
                return;
            }

            const startSerial = 15; 
            const endSerial = startSerial + qty - 1;
            const formatSerial = (num) => num < 10 ? "0" + num : num;
            
            if (qty === 1) {
                previewRange.innerText = `${batch}-${formatSerial(startSerial)}`;
            } else {
                previewRange.innerText = `${batch}-${formatSerial(startSerial)} ~ ${formatSerial(endSerial)}`;
            }
            totalPreview.innerText = qty + " 隻";
        }

        window.onload = initData;
    </script>
</body>
</html>